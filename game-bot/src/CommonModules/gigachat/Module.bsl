
#Область ПрограммныйИнтерфейс

// Отправляет запрос в GigaChat и получает ответ
// 
// Параметры:
//  Сообщение - Строка - текст сообщения для отправки в GigaChat
//  АвторизационныеДанные - Строка - Client ID и Client Secret в формате Base64
//  Модель - Строка - название модели (по умолчанию "GigaChat")
// 
// Возвращаемое значение:
//  Структура - результат запроса с полями:
//   * Успех - Булево - успешность выполнения запроса
//   * Ответ - Строка - текст ответа от GigaChat
//   * КодОшибки - Число - код ошибки (если есть)
//   * ТекстОшибки - Строка - описание ошибки (если есть)
//
Функция ОтправитьСообщение(Сообщение, АвторизационныеДанные, Модель = "GigaChat") Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Ответ", "");
	Результат.Вставить("КодОшибки", 0);
	Результат.Вставить("ТекстОшибки", "");
	
	Попытка
		
		// Получаем токен доступа
		РезультатАвторизации = ПолучитьТокенДоступа(АвторизационныеДанные);
		
		Если Не РезультатАвторизации.Успех Тогда
			Результат.КодОшибки = РезультатАвторизации.КодОшибки;
			Результат.ТекстОшибки = РезультатАвторизации.ТекстОшибки;
			Возврат Результат;
		КонецЕсли;
		
		ТокенДоступа = РезультатАвторизации.ТокенДоступа;
		
		// Формируем запрос к API GigaChat
		РезультатЗапроса = ВыполнитьЗапросКGigaChat(Сообщение, ТокенДоступа, Модель);
		
		Если РезультатЗапроса.Успех Тогда
			Результат.Успех = Истина;
			Результат.Ответ = РезультатЗапроса.Ответ;
		Иначе
			Результат.КодОшибки = РезультатЗапроса.КодОшибки;
			Результат.ТекстОшибки = РезультатЗапроса.ТекстОшибки;
		КонецЕсли;
		
	Исключение
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает токен доступа для работы с API GigaChat
// 
// Параметры:
//  АвторизационныеДанные - Строка - Client ID и Client Secret в формате Base64
// 
// Возвращаемое значение:
//  Структура - результат с полями:
//   * Успех - Булево
//   * ТокенДоступа - Строка - access token
//   * КодОшибки - Число
//   * ТекстОшибки - Строка
//
Функция ПолучитьТокенДоступа(АвторизационныеДанные) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("ТокенДоступа", "");
	Результат.Вставить("КодОшибки", 0);
	Результат.Вставить("ТекстОшибки", "");
	
	Попытка
		
		// Создаем HTTP запрос с таймаутом
		Соединение = Новый HTTPСоединение(
			"ngw.devices.sberbank.ru",
			9443,
			,,,
			30, // Таймаут 30 секунд
			Новый ЗащищенноеСоединениеOpenSSL(Неопределено, Неопределено)
		);
		
		Запрос = Новый HTTPЗапрос("/api/v2/oauth");
		
		// Устанавливаем заголовки
		Запрос.Заголовки.Вставить("Content-Type", "application/x-www-form-urlencoded");
		Запрос.Заголовки.Вставить("Accept", "application/json");
		Запрос.Заголовки.Вставить("RqUID", Строка(Новый УникальныйИдентификатор));
		Запрос.Заголовки.Вставить("Authorization", "Basic " + АвторизационныеДанные);
		
		// Формируем тело запроса
		Запрос.УстановитьТелоИзСтроки("scope=GIGACHAT_API_PERS");
		
		// Отправляем POST запрос
		Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
		
		Если Ответ.КодСостояния = 200 Тогда
			
			// Парсим JSON ответ
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(Ответ.ПолучитьТелоКакСтроку());
			ДанныеОтвета = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если ДанныеОтвета.Свойство("access_token") Тогда
				Результат.Успех = Истина;
				Результат.ТокенДоступа = ДанныеОтвета.access_token;
			Иначе
				Результат.КодОшибки = -1;
				Результат.ТекстОшибки = "В ответе отсутствует access_token";
			КонецЕсли;
			
		Иначе
			Результат.КодОшибки = Ответ.КодСостояния;
			Результат.ТекстОшибки = "Ошибка получения токена: " + Ответ.ПолучитьТелоКакСтроку();
		КонецЕсли;
		
	Исключение
		Результат.КодОшибки = -1;
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выполняет запрос к API GigaChat для получения ответа
//
// Параметры:
//  Сообщение - Строка - текст сообщения
//  ТокенДоступа - Строка - токен авторизации
//  Модель - Строка - название модели
//
// Возвращаемое значение:
//  Структура - результат запроса
//
Функция ВыполнитьЗапросКGigaChat(Сообщение, ТокенДоступа, Модель)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Ответ", "");
	Результат.Вставить("КодОшибки", 0);
	Результат.Вставить("ТекстОшибки", "");
	
	Попытка
		
		// URL для отправки сообщений
		Соединение = Новый HTTPСоединение(
			"gigachat.devices.sberbank.ru",
			443,
			,,,
			60, // Таймаут 60 секунд для генерации ответа
			Новый ЗащищенноеСоединениеOpenSSL(Неопределено, Неопределено)
		);
		
		Запрос = Новый HTTPЗапрос("/api/v1/chat/completions");
		
		// Устанавливаем заголовки
		Запрос.Заголовки.Вставить("Content-Type", "application/json");
		Запрос.Заголовки.Вставить("Accept", "application/json");
		Запрос.Заголовки.Вставить("Authorization", "Bearer " + ТокенДоступа);
		
		// Формируем тело запроса в формате JSON
		ТелоЗапроса = Новый Структура;
		ТелоЗапроса.Вставить("model", Модель);
		
		Сообщения = Новый Массив;
		СообщениеПользователя = Новый Структура;
		СообщениеПользователя.Вставить("role", "user");
		СообщениеПользователя.Вставить("content", Сообщение);
		Сообщения.Добавить(СообщениеПользователя);
		
		ТелоЗапроса.Вставить("messages", Сообщения);
		ТелоЗапроса.Вставить("temperature", 0.7);
		ТелоЗапроса.Вставить("max_tokens", 1024);
		
		// Конвертируем в JSON
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();
		ЗаписатьJSON(ЗаписьJSON, ТелоЗапроса);
		JSONСтрока = ЗаписьJSON.Закрыть();
		
		Запрос.УстановитьТелоИзСтроки(JSONСтрока, КодировкаТекста.UTF8);
		
		// Отправляем POST запрос
		Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
		
		Если Ответ.КодСостояния = 200 Тогда
			
			// Парсим JSON ответ
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(Ответ.ПолучитьТелоКакСтроку());
			ДанныеОтвета = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если ДанныеОтвета.Свойство("choices") 
				И ТипЗнч(ДанныеОтвета.choices) = Тип("Массив")
				И ДанныеОтвета.choices.Количество() > 0 Тогда
				
				ПервыйВыбор = ДанныеОтвета.choices[0];
				
				Если ПервыйВыбор.Свойство("message") 
					И ПервыйВыбор.message.Свойство("content") Тогда
					
					Результат.Успех = Истина;
					Результат.Ответ = ПервыйВыбор.message.content;
					
				Иначе
					Результат.КодОшибки = -1;
					Результат.ТекстОшибки = "Неверная структура ответа от GigaChat";
				КонецЕсли;
				
			Иначе
				Результат.КодОшибки = -1;
				Результат.ТекстОшибки = "В ответе отсутствуют choices";
			КонецЕсли;
			
		Иначе
			Результат.КодОшибки = Ответ.КодСостояния;
			Результат.ТекстОшибки = "Ошибка запроса к GigaChat: " + Ответ.ПолучитьТелоКакСтроку();
		КонецЕсли;
		
	Исключение
		Результат.КодОшибки = -1;
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Кодирует строку в Base64
//
// Параметры:
//  Строка - Строка - исходная строка для кодирования
//
// Возвращаемое значение:
//  Строка - закодированная строка
//
Функция КодироватьВBase64(Знач Строка) Экспорт
	
	ЗаписьДанных = Новый ЗаписьДанных;
	ЗаписьДанных.ЗаписатьСимволы(Строка);
	
	Возврат Base64Строка(ЗаписьДанных.ЗакрытьИПолучитьДвоичныеДанные());
	
КонецФункции

// Создает авторизационные данные для GigaChat
//
// Параметры:
//  ClientID - Строка - Client ID из личного кабинета GigaChat
//  ClientSecret - Строка - Client Secret из личного кабинета GigaChat
//
// Возвращаемое значение:
//  Строка - закодированные авторизационные данные
//
Функция СформироватьАвторизационныеДанные(ClientID, ClientSecret) Экспорт
	
	СтрокаАвторизации = ClientID + ":" + ClientSecret;
	Возврат КодироватьВBase64(СтрокаАвторизации);
	
КонецФункции

#КонецОбласти

